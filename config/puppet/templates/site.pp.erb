##################################
#                                #
#            Variables           #
#                                #
##################################

$app_stage     = "<%= app_stage %>"
$app_domain    = "<%= app_domain %>"
$site_domain   = "<%= site_domain %>"
$app_deploy_to = "<%= app_deploy_to %>"
$app_theme     = "<%= app_theme %>"
$app_name      = "<%= app_name %>"
$app_user      = "<%= app_user %>"
$app_group     = "<%= app_group %>"

# random minute for cron
$random_minute = "<%= rand(60) %>"

<%
if app_stage == "dev"
  erb_path = "#{app_deploy_to}/current/config/puppet/templates"
else
  erb_path = "/home/deploy/tmp/#{app_name}/#{app_stage}/templates"
end

if File.basename(File.dirname(__FILE__)) == "config"
  modules_path = "./puppet/modules"
else
  modules_path = "./config/puppet/modules"
end

# allow us to include ERB fragments with the render statement
require "./config/erb-render.rb"

%>


##################################
#                                #
#          Defines               #
#                                #
##################################

<%= render "#{modules_path}/defines/cron-job.erb" , binding %>
<%= render "#{modules_path}/defines/mysql.erb", binding %>


##################################
#                                #
#     Vagrant DNS override       #
#                                #
##################################


<% if app_stage == "dev" %>
file { "/etc/resolv.conf":
	owner => root,
	group => root,
	mode => 644,
	source => "<%= app_deploy_to %>/current/config/puppet/files/vagrant_resolv.conf"
}
<% end %>


##################################
#                                #
#      Users, groups and dirs    #
#                                #
##################################
<%= render "#{modules_path}/users.erb", binding %>
<%= render "#{modules_path}/home-directories.erb", binding %>

##################################
#                                #
#       Nginx configuration      #
#                                #
##################################

<%= render "#{modules_path}/nginx/base.erb", binding %>
<%= render "#{modules_path}/nginx/uploads.erb", binding %>

##################################
#                                #
#        PHP configuration       #
#                                #
##################################

<%= render "#{modules_path}/php5-fpm.erb", binding %>
<%= render "#{modules_path}/php-logging.erb", binding %>

##################################
#                                #
#            Varnish             #
#                                #
##################################

<%= render "#{modules_path}/varnish.erb", binding %>

##################################
#                                #
#    Create DB if not exists     #
#                                #
##################################

<%= render "#{modules_path}/mysql-db-setup.erb", binding %>

##################################
#                                #
#   'Cloud uploads' S3 script    #
#                                #
##################################


<%= render "#{modules_path}/s3-storage-cron.erb", binding %>
